<project name="Haxe XPath" basedir="." default="all">

    <target name="all" depends="test,haxelib"/>

    <target name="clean" description="Deletes all files generated by the build script.">
        <delete>
            <fileset file="haxedoc.xml"/>
            <fileset dir="doc/content"/>
            <fileset file="doc/index.html"/>
            <fileset file="haxe-xpath-doc.zip"/>
            <fileset file="xpath.zip"/>
            <fileset file="test.n"/>
            <fileset dir="test-java"/>
        </delete>
    </target>

    <target name="haxedoc.xml" description="Generates API documentation XML.">
        <exec executable="haxe" failonerror="true">
            <arg value="-cp"/>
            <arg file="src"/>
            <arg value="-cp"/>
            <arg file="doc"/>
            <arg value="--macro"/>
            <arg value="ImportAll.run()"/>
            <arg value="-neko"/>
            <arg file="doc.n"/>
            <arg value="--no-output"/>
            <arg value="-xml"/>
            <arg file="haxedoc.xml"/>
        </exec>
    </target>

    <target name="haxelib" depends="haxedoc.xml" description="Generates a Haxelib package for distribution.">
        <delete file="xpath.zip"/>

        <zip destfile="xpath.zip">
            <fileset dir="src">
                <include name="**/*.hx"/>
            </fileset>
            <fileset file="haxelib.json"/>
            <fileset file="README.md"/>
            <fileset file="LICENCE.txt"/>
            <fileset file="AUTHORS.txt"/>
            <fileset file="haxedoc.xml"/>
        </zip>
    </target>

    <target name="test.neko" description="Runs the automated tests on Neko.">
        <exec executable="haxe" failonerror="true">
            <arg value="-cp"/>
            <arg file="src"/>
            <arg value="-cp"/>
            <arg file="test"/>
            <arg value="-neko"/>
            <arg file="test.n"/>
            <arg value="-main"/>
            <arg value="xpath.Test"/>
        </exec>

        <exec executable="neko" failonerror="true">
            <arg file="test.n"/>
        </exec>
    </target>

    <target name="test.java" description="Runs the automated tests on Java.">
        <exec executable="haxe" failonerror="true">
            <arg value="-cp"/>
            <arg file="src"/>
            <arg value="-cp"/>
            <arg file="test"/>
            <arg value="-java"/>
            <arg file="test-java"/>
            <arg value="-main"/>
            <arg value="xpath.Test"/>
        </exec>

        <java fork="true" jar="test-java/Test.jar" failonerror="true"/>
    </target>

    <target name="test" depends="test.neko, test.java" description="Runs the automated tests on all platforms"/>

</project>
